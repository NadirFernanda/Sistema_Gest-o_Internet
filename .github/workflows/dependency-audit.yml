name: Dependency Audit

permissions:
  contents: read
  issues: write

on:
  schedule:
    # Runs weekly on Monday at 02:00 UTC
    - cron: '0 2 * * 1'
  workflow_dispatch: {}

jobs:
  composer-audit:
    name: Composer Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Set up PHP
        uses: shivammathur/setup-php@v2
        with:
          php-version: '8.2'

      - name: Install Composer dependencies
        run: composer install --no-progress --no-suggest --prefer-dist

      - name: Run composer audit
        run: |
          composer audit --format=json > composer-audit.json || true

      - name: Upload composer audit
        uses: actions/upload-artifact@v4
        with:
          name: composer-audit
          path: composer-audit.json
      
      - name: Ensure jq is available
        run: |
          sudo apt-get update && sudo apt-get install -y jq || true

      - name: Create issue and fail on critical or high composer vulnerabilities
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = 'composer-audit.json';
            if (!fs.existsSync(path)) {
              core.info('composer-audit.json not present');
              return;
            }
            const payload = JSON.parse(fs.readFileSync(path, 'utf8'));
            const text = JSON.stringify(payload);
            if (text.includes('"severity":"critical"') || text.includes('"severity":"high"')) {
              const title = `Dependency audit: composer high/critical vulnerabilities in ${context.repo.repo}`;
              const body = 'Composer audit report (JSON attached below):\n\n' + '```json\n' + JSON.stringify(payload, null, 2) + '\n```';
              const labels = ['security','dependency-audit'];
              // determine assignee: assign to repo owner if owner is a user
              const repo = await github.rest.repos.get({ owner: context.repo.owner, repo: context.repo.repo });
              let assignees = [];
              if (repo && repo.data && repo.data.owner && repo.data.owner.type === 'User') {
                assignees = [repo.data.owner.login];
              }
              await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels, assignees });
              throw new Error('High/critical composer vulnerabilities found');
            } else {
              core.info('No critical or high composer vulnerabilities found');
            }

  npm-audit:
    name: npm Audit
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      - name: Install npm dependencies
        run: npm ci

      - name: Run npm audit
        run: npm audit --json > npm-audit.json || true

      - name: Upload npm audit
        uses: actions/upload-artifact@v4
        with:
          name: npm-audit
          path: npm-audit.json

      - name: Ensure jq is available
        run: |
          sudo apt-get update && sudo apt-get install -y jq || true

      - name: Create issue and fail on critical or high npm vulnerabilities
        uses: actions/github-script@v6
        with:
          script: |
            const fs = require('fs');
            const path = 'npm-audit.json';
            if (!fs.existsSync(path)) {
              core.info('npm-audit.json not present');
              return;
            }
            const payload = JSON.parse(fs.readFileSync(path, 'utf8'));
            const text = JSON.stringify(payload);
            if (text.includes('"severity":"critical"') || text.includes('"severity":"high"')) {
              const title = `Dependency audit: npm high/critical vulnerabilities in ${context.repo.repo}`;
              const body = 'npm audit report (JSON attached below):\n\n' + '```json\n' + JSON.stringify(payload, null, 2) + '\n```';
              const labels = ['security','dependency-audit'];
              const repo = await github.rest.repos.get({ owner: context.repo.owner, repo: context.repo.repo });
              let assignees = [];
              if (repo && repo.data && repo.data.owner && repo.data.owner.type === 'User') {
                assignees = [repo.data.owner.login];
              }
              await github.rest.issues.create({ owner: context.repo.owner, repo: context.repo.repo, title, body, labels, assignees });
              throw new Error('High/critical npm vulnerabilities found');
            } else {
              core.info('No critical or high npm vulnerabilities found');
            }
